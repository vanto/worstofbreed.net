---
import { getCollection } from "astro:content";

const patterns = await getCollection("patterns");
const patternsData = patterns.map((p) => ({
    title: p.data.title,
    slug: p.slug,
    category: p.data.category,
    stats: p.data.stats,
    quote: p.data.quote,
    specialAbility: p.data.specialAbility,
    imagePlaceholder: p.data.imagePlaceholder,
}));
---

<pattern-of-the-day data-patterns={JSON.stringify(patternsData)}>
    <div class="pattern-card-wrapper">
        <div class="pattern-content" hidden>
            <div class="brutalist-card">
                <header class="card-header">
                    <span class="label"
                        >PATTERN OF THE DAY // <span class="pattern-date"
                        ></span></span
                    >
                    <span class="badge pattern-category"></span>
                </header>

                <div class="pattern-title-section">
                    <h3>
                        <a href="#" class="pattern-link pattern-title"></a>
                    </h3>
                </div>

                <div class="card-body">
                    <blockquote class="quote pattern-quote"></blockquote>
                    <div class="ability">
                        <span class="ability-title pattern-ability-name"></span>
                        <p class="ability-desc pattern-ability-desc"></p>
                    </div>
                </div>

                <footer class="card-footer">
                    <button
                        class="shuffle-btn"
                        type="button"
                        title="Get another bad idea">↻ SHUFFLE</button
                    >
                    <a href="#" class="pattern-link-btn"
                        >OPEN PATTERN FILE &rarr;</a
                    >
                </footer>
            </div>
        </div>
    </div>
</pattern-of-the-day>

<script>
    class PatternOfTheDay extends HTMLElement {
        private shuffleCount: number = 0;

        constructor() {
            super();
            this.shuffleCount = 0;
            this.init();
        }

        init() {
            try {
                const patternsJson = this.dataset.patterns;
                if (!patternsJson) return;
                const patterns = JSON.parse(patternsJson);
                if (!patterns || patterns.length === 0) return;

                // Bind shuffle button
                const shuffleBtn = this.querySelector(".shuffle-btn");
                if (shuffleBtn) {
                    shuffleBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.shuffleCount++;
                        this.renderPattern(patterns);
                    });
                } else {
                    console.warn("Shuffle button not found");
                }

                this.renderPattern(patterns);
            } catch (e) {
                console.error("POTD Error", e);
            }
        }

        renderPattern(patterns: any[]) {
            const seed = this.getDailySeed() + this.shuffleCount;
            const randomIndex = this.seededRandom(seed, patterns.length);
            const pattern = patterns[randomIndex];
            this.render(pattern);
        }

        getDailySeed() {
            const now = new Date();
            // YYYYMMDD
            return (
                now.getUTCFullYear() * 10000 +
                (now.getUTCMonth() + 1) * 100 +
                now.getUTCDate()
            );
        }

        seededRandom(seed: number, max: number) {
            // Mulberry32-inspired one-off hash to ensure good distribution
            // even with sequential seeds (like dates or counters).
            let t = (seed += 0x6d2b79f5);
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            const random = ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            return Math.floor(random * max);
        }

        render(pattern: any) {
            const content = this.querySelector(".pattern-content");
            if (content) content.removeAttribute("hidden");

            // Fill Data
            const set = (sel: string, txt: string) => {
                const el = this.querySelector(sel);
                if (el) el.textContent = txt;
            };

            // Date
            const now = new Date();
            set(".pattern-date", now.toISOString().split("T")[0]);

            set(".pattern-category", pattern.category);
            set(".pattern-title", pattern.title);

            set(".pattern-quote", `> "${pattern.quote}"`);

            if (pattern.specialAbility) {
                set(
                    ".pattern-ability-name",
                    `★ ${pattern.specialAbility.name}`,
                );
                set(
                    ".pattern-ability-desc",
                    pattern.specialAbility.description,
                );
            }

            // Links
            const slug = pattern.slug;
            const links = this.querySelectorAll<HTMLAnchorElement>("a");
            links.forEach((l) => (l.href = `/patterns/${slug}`));
        }
    }
    customElements.define("pattern-of-the-day", PatternOfTheDay);
</script>

<style>
    pattern-of-the-day {
        display: block;
        margin-bottom: 0;
        width: 100%;
        height: 100%;
    }

    .pattern-card-wrapper,
    .pattern-content {
        height: 100%;
    }

    .brutalist-card {
        background: var(--paper, #fff);
        border: 4px solid var(--ink, #000);
        box-shadow: 12px 12px 0px var(--accent, #666);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .card-header {
        background: var(--ink, #000);
        color: var(--paper, #fff);
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: var(--font-mono, monospace);
        text-transform: uppercase;
        font-weight: bold;
    }

    .pattern-title-section {
        padding: 1rem;
        border-bottom: 2px solid var(--ink, #000);
        background: var(--paper, #fff);
    }

    .pattern-title {
        font-size: 1.8rem;
        margin: 0;
        text-transform: uppercase;
        text-decoration: none;
        color: var(--ink, #000);
        display: block;
    }

    .pattern-title:hover {
        color: var(--accent, blue);
        text-decoration: underline;
    }

    .card-body {
        padding: 1rem;
        flex-grow: 1;
    }

    .quote {
        border-left: 4px solid var(--accent, #666);
        padding-left: 10px;
        font-style: italic;
        margin: 0 0 1rem 0;
        color: var(--ink, #000);
    }

    .ability {
        background: #f0f0f0;
        border: 2px solid var(--ink, #000);
        padding: 0.8rem;
    }

    .ability-title {
        font-weight: bold;
        text-transform: uppercase;
        display: block;
        margin-bottom: 0.4rem;
        font-family: var(--font-mono, monospace);
    }

    .ability-desc {
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .card-footer {
        background: var(--ink, #000);
        padding: 0.8rem;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .pattern-link-btn {
        background: var(--accent, yellow);
        color: var(--ink, #000);
        text-decoration: none;
        padding: 0.5rem 1rem;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
        font-family: var(--font-mono, monospace);
    }

    .pattern-link-btn:hover {
        filter: invert(1);
    }

    .shuffle-btn {
        background: transparent;
        color: var(--paper, #fff);
        border: 2px solid var(--paper, #fff);
        padding: 0.5rem 1rem;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
        font-family: var(--font-mono, monospace);
        cursor: pointer;
    }

    .shuffle-btn:hover {
        background: var(--paper, #fff);
        color: var(--ink, #000);
    }

    .badge {
        background: var(--accent, yellow);
        color: var(--ink, #000);
        padding: 2px 6px;
        font-size: 0.7rem;
    }
</style>
